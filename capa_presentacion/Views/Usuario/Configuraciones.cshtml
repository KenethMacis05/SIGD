
@{
    ViewBag.Title = "Configuraciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!--Titulo-->
<div class="alert text-center mt-4" style="background-color: #F7F7F7; border: 1px #D2D2D2 solid " role="alert"><h2 class="fs-3">Configuraciones</h2></div>


<!--Contenedor-->
<div class="card">
    <div class="card-body">
        <div class="row justify-content-center">
            <!-- Perfil / Avatar / Info lateral -->
            <div class="col-lg-3 user-profile-card card shadow-sm p-3">
                <div class="text-center position-relative">
                    <!-- Botón X (limpiar imagen) -->
                    <button type="button" class="btn position-absolute"
                            style="top: 1px; left: 1px; z-index: 3;"
                            title="Limpiar imagen" onclick="clearFoto()">
                        <i class="fas fa-times text-danger fs-3"></i>
                    </button>
                    <div class="avatar-border mx-auto mb-2" style="width: 250px; height: 250px; position: relative;">
                        <svg width="250" height="250" viewBox="0 0 250 250"
                             style="position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;">
                            <!-- Rojo: Primer tercio -->
                            <circle cx="125" cy="125" r="120" fill="none"
                                    stroke="#DA2032" stroke-width="10"
                                    stroke-dasharray="251.3 502.65"
                                    stroke-dashoffset="0" />
                            <!-- Azul: Segundo tercio -->
                            <circle cx="125" cy="125" r="120" fill="none"
                                    stroke="#094FA3" stroke-width="10"
                                    stroke-dasharray="251.3 502.65"
                                    stroke-dashoffset="251.3" />
                            <!-- Amarillo: Tercer tercio -->
                            <circle cx="125" cy="125" r="120" fill="none"
                                    stroke="#F7BE2A" stroke-width="10"
                                    stroke-dasharray="251.3 502.65"
                                    stroke-dashoffset="502.6" />
                        </svg>
                        <img id="avatarImg"
                             src="@(ViewBag.FotoUrl ?? "https://ssl.gstatic.com/accounts/ui/avatar_2x.png")"
                             class="rounded-circle"
                             alt="avatar"
                             style="width: 225px; height: 225px; object-fit: cover; position: absolute; top: 12px; left: 12px; z-index: 2; background: #fff;">
                    </div>
                    <div class="text-center">
                        <div class="fw-bold fs-5 text-dark">@ViewBag.PriNombreAut @ViewBag.PriApellidoAut</div>
                        <div class="text-secondary small">@ViewBag.CorreoAut</div>
                        <div class="badge text-white fw-bold mt-1 w-100" style="font-size: 0.95rem; letter-spacing: 1px; background: #0072BB;">
                            @ViewBag.RolUsuario - @ViewBag.UsuarioAut
                        </div>
                    </div>
                    <label class="btn btn-outline-secondary btn-sm mt-4 w-100" for="fotoPerfil">
                        <i class="fas fa-camera me-1"></i> Cambiar foto
                        <input type="file" class="form-control visually-hidden" id="fotoPerfil" name="fotoPerfil" accept="image/*" autocomplete="off" onchange="previewFoto(event)">
                    </label>
                    <!-- Botón Guardar (guardar imagen) -->
                    <button type="button" class="btn btn-outline-primary btn-sm mt-4 w-100"
                            id="saveFotoBtn"
                            title="Guardar imagen" onclick="saveFoto()" disabled>
                        <i class="fas fa-save text-primary"></i> Guardar Imagen
                    </button>
                </div>
            </div>

            <!-- Formulario de configuración -->
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header pb-0 border-bottom-0">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <!--Boton 1-->
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active esp-link" id="home-tab" data-bs-toggle="tab" data-bs-target="#home"
                                        type="button" role="tab" aria-controls="home" aria-selected="true">
                                    Datos personales
                                </button>
                            </li>
                            <!--Boton 2-->
                            <li class="nav-item" role="presentation">
                                <button class="nav-link esp-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile"
                                        type="button" role="tab" aria-controls="profile" aria-selected="false">
                                    Actualizar contraseña
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="myTabContent">
                            <!--Contenedor 1-->
                            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                                <form id="configUserForm" autocomplete="off">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="priNombre" class="form-label">Primer nombre</label>
                                            <input type="text" class="form-control" id="priNombre" name="priNombre" autocomplete="off" value="@ViewBag.PriNombreAut">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="segNombre" class="form-label">Segundo nombre</label>
                                            <input type="text" class="form-control" id="segNombre" name="segNombre" autocomplete="off" value="@ViewBag.SegNombreAut" required>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="priApellido" class="form-label">Primer apellido</label>
                                            <input type="text" class="form-control" id="priApellido" name="priApellido" autocomplete="off" value="@ViewBag.PriApellidoAut">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="segApellido" class="form-label">Segundo apellido</label>
                                            <input type="text" class="form-control" id="segApellido" name="segApellido" autocomplete="off" value="@ViewBag.SegApellidoAut" required>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="correo" class="form-label">Correo electrónico</label>
                                            <input type="email" class="form-control" id="correo" name="correo" autocomplete="off" value="@ViewBag.CorreoAut" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="telefono" class="form-label">Teléfono</label>
                                            <input type="text" class="form-control" id="telefono" name="telefono" maxlength="8" pattern="\d{8}" title="Debe ingresar exactamente 8 números" autocomplete="off" value="@ViewBag.TelefonoAut" required>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="usuario" class="form-label">Usuario</label>
                                            <input type="text" class="form-control" id="usuario" name="usuario" autocomplete="off" value="@ViewBag.UsuarioAut" disabled>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        <button type="submit" class="btn text-white" style="background: #0072BB">
                                            <i class="fas fa-save me-1"></i> Guardar Cambios
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <!--Contenedor 2-->
                            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                                <form id="resetPasswordForm" autocomplete="off" novalidate>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="email" class="form-label">Correo electrónico</label>
                                            <input type="email" class="form-control" id="email" placeholder="Ingrese su correo electrónico" required autocomplete="off">
                                            <div class="invalid-feedback">Por favor, ingresa tu correo electrónico.</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="current-password" class="form-label">Contraseña actual</label>
                                            <input type="password" class="form-control" id="current-password" placeholder="Ingrese su contraseña actual" required autocomplete="off">
                                            <div class="invalid-feedback">Por favor, ingresa tu contraseña actual.</div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="new-password" class="form-label">Nueva contraseña</label>
                                            <input type="password" class="form-control" id="new-password" placeholder="Ingrese nueva contraseña" required autocomplete="off">
                                            <div class="invalid-feedback">Por favor, ingresa una nueva contraseña.</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="confirm-password" class="form-label">Confirmar nueva contraseña</label>
                                            <input type="password" class="form-control" id="confirm-password" placeholder="Confirme su nueva contraseña" required autocomplete="off">
                                            <div class="invalid-feedback">Por favor, confirma tu nueva contraseña.</div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn text-white" style="background: #0072BB" id="btnReiniciar">
                                            <i class="fas fa-save me-1"></i> Reiniciar contraseña
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
 
@section Scripts {
    <script>
        // Validación personalizada para todos los inputs requeridos
        document.getElementById('btnReiniciar').onclick = function (e) {
            let form = document.getElementById('resetPasswordForm');
            let isValid = true;

            // Buscar todos los inputs requeridos dentro del formulario
            let requiredInputs = form.querySelectorAll('input[required]');

            requiredInputs.forEach(function (input) {
                input.classList.remove('is-invalid');
                if (input.value.trim() === "") {
                    input.classList.add('is-invalid');
                    isValid = false;
                }
            });

            // Validar que las contraseñas coincidan
            let newPassword = form.querySelector('#new-password');
            let confirmPassword = form.querySelector('#confirm-password');
            if (newPassword.value && confirmPassword.value && newPassword.value !== confirmPassword.value) {
                confirmPassword.classList.add('is-invalid');
                confirmPassword.nextElementSibling.textContent = "Las contraseñas no coinciden.";
                isValid = false;
            } else if (confirmPassword.value) {
                confirmPassword.nextElementSibling.textContent = "Por favor, confirma tu nueva contraseña.";
            }

            if (isValid) {
                ActualizarPassword();
            }            
        };

        // Quitar borde rojo al corregir
        document.querySelectorAll('#resetPasswordForm input[required]').forEach(function (input) {
            input.addEventListener('input', function () {
                if (this.value.trim() !== "") this.classList.remove('is-invalid');
            });
        });

        function ActualizarPassword() {
            console.log("Hola");
            // Tu lógica para reiniciar la contraseña aquí
        }

        // Guarda la URL original al cargar la página
        let originalAvatarUrl = document.getElementById('avatarImg').src;

        // Si la imagen se cambia, muestra el botón guardar y activa la X
        function previewFoto(event) {
            const input = event.target;
            const saveBtn = document.getElementById('saveFotoBtn');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('avatarImg').src = e.target.result;
                    saveBtn.disabled = false;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Limpiar el filtro: restaurar imagen original y resetear input
        function clearFoto() {
            document.getElementById('avatarImg').src = originalAvatarUrl;
            document.getElementById('fotoPerfil').value = "";
            document.getElementById('saveFotoBtn').disabled = true;
        }

        // Guardar la foto (implementa aquí tu lógica AJAX para guardar en servidor)
        function saveFoto() {
            // Ejemplo: obtén la imagen en base64
            let imgSrc = document.getElementById('avatarImg').src;
            // Aquí deberías hacer un POST con AJAX con la imagen
            alert('Foto guardada (simulado). Aquí deberías enviar la imagen al servidor.');
            document.getElementById('saveFotoBtn').disabled = true;
            // Si guardas exitosamente, podrías actualizar originalAvatarUrl:
            originalAvatarUrl = imgSrc;
        }
    </script>
}